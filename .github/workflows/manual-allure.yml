name: Next.js UI tests + Allure report (manual)

on:
  workflow_dispatch:

permissions:
  contents: write
  checks: write
  actions: read

jobs:
  test-and-publish:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: package-lock.json

      - name: Install Node dependencies
        run: npm ci

      - name: Build static site
        run: npm run build

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install Python deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Setup Chrome + matching ChromeDriver
        id: setup-chrome
        uses: browser-actions/setup-chrome@v2
        with:
          chrome-version: stable
          install-chromedriver: true

      - name: Debug browser/driver versions
        run: |
          ${{ steps.setup-chrome.outputs.chrome-path }} --version
          ${{ steps.setup-chrome.outputs.chromedriver-path }} --version

      - name: Serve static site
        run: |
          npx serve@14 -s out -l 3000 &
          for i in {1..30}; do
            curl -sSf http://127.0.0.1:3000 >/dev/null && break
            sleep 1
          done

      - name: Run tests
        id: ui_tests
        continue-on-error: true
        env:
          BASE_URL: http://127.0.0.1:3000
          CHROME_BIN: ${{ steps.setup-chrome.outputs.chrome-path }}
          CHROMEDRIVER_PATH: ${{ steps.setup-chrome.outputs.chromedriver-path }}
        run: |
          mkdir -p reports
          pytest -q tests \
            --alluredir=allure-results \
            --clean-alluredir \
            --junit-xml=reports/junit.xml

      - name: Publish JUnit results in pipeline (Dorny)
        if: ${{ !cancelled() }}
        uses: dorny/test-reporter@v2
        with:
          name: Pytest JUnit
          path: reports/junit.xml
          reporter: python-xunit
          use-actions-summary: "true"
          fail-on-error: "false"

      - name: Upload JUnit report artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: junit-xml
          path: reports/junit.xml
          if-no-files-found: error

      - name: Load previous Allure history
        if: always()
        continue-on-error: true
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          path: gh-pages

      - name: Build Allure report
        if: always()
        uses: simple-elf/allure-report-action@v1.13
        with:
          gh_pages: gh-pages
          allure_results: allure-results
          allure_report: allure-report
          allure_history: allure-history

      - name: Publish to gh-pages
        if: always()
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_branch: gh-pages
          publish_dir: allure-history

      - name: Print Allure URL in logs + workflow summary
        if: always()
        run: |
          OWNER="${GITHUB_REPOSITORY_OWNER}"
          REPO="${GITHUB_REPOSITORY#*/}"

          # user/organization site repo special case: owner.github.io
          if [ "$REPO" = "${OWNER}.github.io" ]; then
            URL="https://${OWNER}.github.io/"
          else
            URL="https://${OWNER}.github.io/${REPO}/"
          fi

          echo "Allure report URL: $URL"

          echo "## Test reports" >> $GITHUB_STEP_SUMMARY
          echo "- Allure report: [$URL]($URL)" >> $GITHUB_STEP_SUMMARY
          echo "- JUnit check: see **Checks** section (Dorny Test Reporter)" >> $GITHUB_STEP_SUMMARY
          echo "- JUnit XML artifact: **junit-xml** (download from Artifacts section)" >> $GITHUB_STEP_SUMMARY

      - name: Keep pipeline red if tests failed
        if: always()
        run: |
          if [ "${{ steps.ui_tests.outcome }}" != "success" ]; then
            echo "Some tests failed."
            exit 1
          fi
